name: CI/CD Pipeline

# ÐšÐ¾Ð³Ð´Ð° Ð·Ð°Ð¿ÑƒÑÐºÐ°ÐµÑ‚ÑÑ:
# - ÐŸÑ€Ð¸ push Ð² Ð²ÐµÑ‚ÐºÐ¸ main/develop
# - ÐŸÑ€Ð¸ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ð¸ Pull Request Ð² main
on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

# Ð“Ð»Ð¾Ð±Ð°Ð»ÑŒÐ½Ñ‹Ðµ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ
env:
  DOTNET_VERSION: '8.0.x'
  NODE_VERSION: '18'
  DOCKER_BUILDKIT: 1

jobs:
  # ==========================================
  # JOB 1: ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¸ ÑÐ±Ð¾Ñ€ÐºÐ° Backend (.NET)
  # ==========================================
  backend:
    name: Backend Build & Lint
    runs-on: ubuntu-latest
    
    steps:
      # Ð¨Ð°Ð³ 1: ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ ÐºÐ¾Ð´ Ð¸Ð· Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      # Ð¨Ð°Ð³ 2: Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ .NET SDK
      - name: ðŸ”§ Setup .NET ${{ env.DOTNET_VERSION }}
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      # Ð¨Ð°Ð³ 3: ÐšÑÑˆÐ¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ NuGet Ð¿Ð°ÐºÐµÑ‚Ñ‹ Ð´Ð»Ñ ÑƒÑÐºÐ¾Ñ€ÐµÐ½Ð¸Ñ ÑÐ±Ð¾Ñ€ÐºÐ¸
      - name: ðŸ“¦ Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: ${{ runner.os }}-nuget-${{ hashFiles('**/packages.lock.json') }}
          restore-keys: |
            ${{ runner.os }}-nuget-

      # Ð¨Ð°Ð³ 4: Ð’Ð¾ÑÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸
      - name: ðŸ“¦ Restore dependencies
        run: dotnet restore graph-visualization-app/backend/src/GraphVisualizationApp/GraphVisualizationApp.csproj

      # Ð¨Ð°Ð³ 5: Ð¡Ð¾Ð±Ñ€Ð°Ñ‚ÑŒ Ð¿Ñ€Ð¾ÐµÐºÑ‚
      - name: ðŸ”¨ Build backend
        run: dotnet build graph-visualization-app/backend/src/GraphVisualizationApp/GraphVisualizationApp.csproj --configuration Release --no-restore

      # Ð¨Ð°Ð³ 6: Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ Ñ‚ÐµÑÑ‚Ñ‹ (ÐºÐ¾Ð³Ð´Ð° Ð¿Ð¾ÑÐ²ÑÑ‚ÑÑ)
      # TODO: Ð Ð°ÑÐºÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ ÐºÐ¾Ð³Ð´Ð° ÑÐ¾Ð·Ð´Ð°Ð´Ð¸Ñ‚Ðµ Ñ‚ÐµÑÑ‚Ñ‹
      # - name: ðŸ§ª Run tests
      #   run: dotnet test graph-visualization-app/backend/tests/ --configuration Release --no-build --verbosity normal

      # Ð¨Ð°Ð³ 7: ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ð° ÐºÐ¾Ð´Ð° (Ð¾Ð¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾)
      - name: ðŸŽ¨ Check code format
        run: dotnet format graph-visualization-app/backend/src/GraphVisualizationApp/GraphVisualizationApp.csproj --verify-no-changes --verbosity diagnostic
        continue-on-error: true  # ÐÐµ Ð±Ð»Ð¾ÐºÐ¸Ñ€ÑƒÐµÐ¼ ÑÐ±Ð¾Ñ€ÐºÑƒ, Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¿Ñ€ÐµÐ´ÑƒÐ¿Ñ€ÐµÐ¶Ð´Ð°ÐµÐ¼

  # ==========================================
  # JOB 2: ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¸ ÑÐ±Ð¾Ñ€ÐºÐ° Frontend (React)
  # ==========================================
  frontend:
    name: Frontend Build & Lint
    runs-on: ubuntu-latest
    
    steps:
      # Ð¨Ð°Ð³ 1: ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ ÐºÐ¾Ð´
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      # Ð¨Ð°Ð³ 2: Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Node.js
      - name: ðŸ”§ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: graph-visualization-app/frontend/package-lock.json

      # Ð¨Ð°Ð³ 3: Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸
      - name: ðŸ“¦ Install dependencies
        run: |
          cd graph-visualization-app/frontend
          npm ci

      # Ð¨Ð°Ð³ 4: ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÐºÐ¾Ð´Ð° ESLint (ÐµÑÐ»Ð¸ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½)
      - name: ðŸŽ¨ Lint code
        run: |
          cd graph-visualization-app/frontend
          npm run lint || echo "âš ï¸ ESLint Ð½Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½, Ð¿Ñ€Ð¾Ð¿ÑƒÑÐºÐ°ÐµÐ¼"
        continue-on-error: true

      # Ð¨Ð°Ð³ 5: ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° TypeScript
      - name: ðŸ” TypeScript check
        run: |
          cd graph-visualization-app/frontend
          npx tsc --noEmit

      # Ð¨Ð°Ð³ 6: Ð¡Ð¾Ð±Ñ€Ð°Ñ‚ÑŒ production bundle
      - name: ðŸ”¨ Build frontend
        run: |
          cd graph-visualization-app/frontend
          npm run build
        env:
          NODE_OPTIONS: --openssl-legacy-provider

      # Ð¨Ð°Ð³ 7: Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ Ñ‚ÐµÑÑ‚Ñ‹ (ÐºÐ¾Ð³Ð´Ð° Ð¿Ð¾ÑÐ²ÑÑ‚ÑÑ)
      # TODO: Ð Ð°ÑÐºÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ ÐºÐ¾Ð³Ð´Ð° ÑÐ¾Ð·Ð´Ð°Ð´Ð¸Ñ‚Ðµ Ñ‚ÐµÑÑ‚Ñ‹
      # - name: ðŸ§ª Run tests
      #   run: |
      #     cd graph-visualization-app/frontend
      #     npm test -- --coverage --watchAll=false

      # Ð¨Ð°Ð³ 8: Ð¡Ð¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ build Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚Ñ‹
      - name: ðŸ“¤ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: graph-visualization-app/frontend/dist
          retention-days: 7

  # ==========================================
  # JOB 3: ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚Ð¸ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹
  # ==========================================
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      # Backend: ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° .NET Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹
      - name: ðŸ”’ Scan .NET dependencies
        run: |
          dotnet list graph-visualization-app/backend/src/GraphVisualizationApp/GraphVisualizationApp.csproj package --vulnerable --include-transitive 2>&1 | tee dotnet-vulnerabilities.txt
          if grep -q "has the following vulnerable packages" dotnet-vulnerabilities.txt; then
            echo "âš ï¸ ÐÐ°Ð¹Ð´ÐµÐ½Ñ‹ ÑƒÑÐ·Ð²Ð¸Ð¼Ð¾ÑÑ‚Ð¸ Ð² .NET Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÑÑ…"
            exit 1
          fi
        continue-on-error: true

      # Frontend: ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° npm Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹
      - name: ðŸ”’ Scan npm dependencies
        run: |
          cd graph-visualization-app/frontend
          npm audit --audit-level=moderate || echo "âš ï¸ ÐÐ°Ð¹Ð´ÐµÐ½Ñ‹ ÑƒÑÐ·Ð²Ð¸Ð¼Ð¾ÑÑ‚Ð¸ Ð² npm Ð¿Ð°ÐºÐµÑ‚Ð°Ñ…"
        continue-on-error: true

  # ==========================================
  # JOB 4: Ð¡Ð±Ð¾Ñ€ÐºÐ° Docker Ð¾Ð±Ñ€Ð°Ð·Ð¾Ð²
  # ==========================================
  docker:
    name: Docker Build
    runs-on: ubuntu-latest
    needs: [backend, frontend]  # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÑ‚ÑÑ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÐµÑÐ»Ð¸ backend Ð¸ frontend ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ ÑÐ¾Ð±Ñ€Ð°Ð»Ð¸ÑÑŒ
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      # ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Docker Buildx Ð´Ð»Ñ Ð¼Ð½Ð¾Ð³Ð¾Ð¿Ð»Ð°Ñ‚Ñ„Ð¾Ñ€Ð¼ÐµÐ½Ð½Ð¾Ð¹ ÑÐ±Ð¾Ñ€ÐºÐ¸
      - name: ðŸ”§ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # Ð’Ñ…Ð¾Ð´ Ð² Docker Hub (Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð´Ð»Ñ push Ð² main)
      # TODO: Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ DOCKER_USERNAME Ð¸ DOCKER_PASSWORD Ð² GitHub Secrets
      - name: ðŸ”‘ Login to Docker Hub
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
        continue-on-error: true

      # Ð¡Ð±Ð¾Ñ€ÐºÐ° backend Ð¾Ð±Ñ€Ð°Ð·Ð°
      - name: ðŸ³ Build backend image
        uses: docker/build-push-action@v5
        with:
          context: ./graph-visualization-app/backend
          file: ./graph-visualization-app/backend/Dockerfile
          push: false  # ÐŸÐ¾ÐºÐ° Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÑÐ¾Ð±Ð¸Ñ€Ð°ÐµÐ¼, Ð½Ðµ Ð¿ÑƒÑˆÐ¸Ð¼
          tags: |
            graph-visualization-backend:latest
            graph-visualization-backend:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # Ð¡Ð±Ð¾Ñ€ÐºÐ° frontend Ð¾Ð±Ñ€Ð°Ð·Ð°
      - name: ðŸ³ Build frontend image
        uses: docker/build-push-action@v5
        with:
          context: ./graph-visualization-app/frontend
          file: ./graph-visualization-app/frontend/Dockerfile
          push: false  # ÐŸÐ¾ÐºÐ° Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÑÐ¾Ð±Ð¸Ñ€Ð°ÐµÐ¼, Ð½Ðµ Ð¿ÑƒÑˆÐ¸Ð¼
          tags: |
            graph-visualization-frontend:latest
            graph-visualization-frontend:${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # Ð¢ÐµÑÑ‚Ð¾Ð²Ñ‹Ð¹ Ð·Ð°Ð¿ÑƒÑÐº Ð²ÑÐµÐ³Ð¾ ÑÑ‚ÐµÐºÐ° Ñ‡ÐµÑ€ÐµÐ· docker compose
      - name: ðŸ§ª Test docker compose
        run: |
          cd graph-visualization-app
          # ÐšÐ¾Ð¿Ð¸Ñ€ÑƒÐµÐ¼ Ð¿Ñ€Ð¸Ð¼ÐµÑ€ env Ñ„Ð°Ð¹Ð»Ð°
          cp .env.example .env
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ‡Ñ‚Ð¾ docker compose ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ Ð²Ð°Ð»Ð¸Ð´Ð½Ð°
          docker compose config
          # ÐœÐ¾Ð¶Ð½Ð¾ Ð´Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ Ð¿Ð¾Ð»Ð½Ñ‹Ð¹ Ð·Ð°Ð¿ÑƒÑÐº, Ð½Ð¾ ÑÑ‚Ð¾ Ð·Ð°Ð¹Ð¼Ñ‘Ñ‚ Ð²Ñ€ÐµÐ¼Ñ:
          # docker compose up -d
          # sleep 30
          # curl http://localhost:5000/api/health
          # docker compose down

  # ==========================================
  # JOB 5: Ð˜Ñ‚Ð¾Ð³Ð¾Ð²Ñ‹Ð¹ Ð¾Ñ‚Ñ‡Ñ‘Ñ‚
  # ==========================================
  summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [backend, frontend, security, docker]
    if: always()  # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÑ‚ÑÑ Ð²ÑÐµÐ³Ð´Ð°, Ð´Ð°Ð¶Ðµ ÐµÑÐ»Ð¸ Ñ‡Ñ‚Ð¾-Ñ‚Ð¾ ÑƒÐ¿Ð°Ð»Ð¾
    
    steps:
      - name: ðŸ“Š Generate summary
        run: |
          echo "## ðŸŽ‰ CI/CD Pipeline Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Backend**: ${{ needs.backend.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Frontend**: ${{ needs.frontend.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Security**: ${{ needs.security.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Docker**: ${{ needs.docker.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch**: ${{ github.ref }}" >> $GITHUB_STEP_SUMMARY
